<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>勤怠管理システム - ユーザー管理</title>
	<link th:href="@{/css/style.css}" rel="stylesheet">
</head>

<body>
	<div class="header">
		<h1>勤怠管理システム</h1>
		<div class="user-info">
			<span th:text="${loginUser.name}">ユーザー名</span>さん
			<a th:href="@{#}" onclick="confirmLogout()" class="logout-link">ログアウト</a>
		</div>
	</div>

	<div class="container">
		<div class="nav-links">
			<a th:href="@{/top}">← トップページ</a>
		</div>

		<div class="search-container">
			<div class="admin-badge">管理者限定</div>
			<h2>ユーザー検索</h2>
			<p>ユーザーIDで検索して、ユーザー情報を表示・編集できます。</p>

			<form th:action="@{/user/search}" method="get" class="search-form">
				<div class="form-group" style="margin-bottom: 0;">
					<label for="searchUserId">ユーザーID：</label>
					<input type="text" name="userId" id="searchUserId" placeholder="例：USER001" required>
				</div>
				<button type="submit" class="btn-primary">検索</button>
			</form>
		</div>

		<!-- ユーザー情報表示（検索結果） -->
		<div class="form-container" th:if="${targetUser != null}">
			<h3>ユーザー情報</h3>

			<div class="user-details">
				<div class="detail-row">
					<span class="detail-label">ユーザーID：</span>
					<span class="detail-value" th:text="${targetUser.userId}">USER001</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">氏名：</span>
					<span class="detail-value" th:text="${targetUser.name}">山田太郎</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">所属部門：</span>
					<span class="detail-value" th:text="${targetUser.deptName}">開発部門</span>
				</div>
				<div class="detail-row">
					<span class="detail-label">所属コード：</span>
					<span class="detail-value" th:text="${targetUser.deptCode}">DEV</span>
				</div>
			</div>

			<h4>ユーザー情報編集</h4>

			<!-- メッセージ表示（ユーザー情報編集部分） -->
			<div th:if="${successMessage != null and !successMessage.empty}" th:text="${successMessage}"
				class="message success-message"></div>
			<div th:if="${errorMessage != null and !errorMessage.empty}" th:text="${errorMessage}"
				class="message error-message"></div>

			<form th:action="@{/user/update}" th:object="${userForm}" method="post" onsubmit="return preventDuplicateSubmit(this)">
				<div class="form-group">
					<label for="editUserId">ユーザーID：</label>
					<input type="text" th:field="*{userId}" id="editUserId" readonly style="background-color: #e9ecef;">
				</div>

				<div class="form-group">
					<label for="editPass">パスワード：</label>
					<input type="password" th:field="*{pass}" id="editPass" required>
					<div th:if="${#fields.hasErrors('pass')}" th:errors="*{pass}"
						style="color: red; font-size: 0.8rem;"></div>
				</div>

				<div class="form-group">
					<label for="editDeptCode">所属コード：</label>
					<select th:field="*{deptCode}" id="editDeptCode" required>
						<option value="">選択してください</option>
						<option value="SOUMU">SOUMU（総務部門）</option>
						<option value="EIGYO">EIGYO（営業部門）</option>
						<option value="DEV">DEV（開発部門）</option>
					</select>
					<div th:if="${#fields.hasErrors('deptCode')}" th:errors="*{deptCode}"
						style="color: red; font-size: 0.8rem;"></div>
				</div>

				<div class="form-group">
					<label for="editDeptName">所属名：</label>
					<input type="text" th:field="*{deptName}" id="editDeptName" required>
					<div th:if="${#fields.hasErrors('deptName')}" th:errors="*{deptName}"
						style="color: red; font-size: 0.8rem;"></div>
				</div>

				<div class="form-group">
					<label for="editName">氏名：</label>
					<input type="text" th:field="*{name}" id="editName" required>
					<div th:if="${#fields.hasErrors('name')}" th:errors="*{name}"
						style="color: red; font-size: 0.8rem;"></div>
				</div>

				<div class="button-group">
					<button type="submit" class="btn-warning">更新</button>
					<button type="button" class="btn-danger" onclick="deleteUser()">削除</button>
				</div>
			</form>
		</div>

		<!-- 新規ユーザー登録 -->
		<div class="form-container">
			<h3>新規ユーザー登録</h3>

			<!-- メッセージ表示（新規ユーザー登録部分） -->
			<div th:if="${successMessage != null and !successMessage.empty and targetUser == null}"
				th:text="${successMessage}" class="message success-message"></div>
			<div th:if="${errorMessage != null and !errorMessage.empty and targetUser == null}"
				th:text="${errorMessage}" class="message error-message"></div>

			<form th:action="@{/user/register}" th:object="${newUserForm}" method="post" onsubmit="return preventDuplicateSubmit(this)">
				<div class="form-group">
					<label for="newUserId">ユーザーID：</label>
					<input type="text" th:field="*{userId}" id="newUserId" placeholder="例：USER002" required>
					<div th:if="${#fields.hasErrors('userId') and targetUser == null}" th:errors="*{userId}"
						style="color: red; font-size: 0.8rem;"></div>
				</div>

				<div class="form-group">
					<label for="newPass">パスワード：</label>
					<input type="password" th:field="*{pass}" id="newPass" required>
					<div th:if="${#fields.hasErrors('pass') and targetUser == null}" th:errors="*{pass}"
						style="color: red; font-size: 0.8rem;"></div>
				</div>

				<div class="form-group">
					<label for="newDeptCode">所属コード：</label>
					<select th:field="*{deptCode}" id="newDeptCode" required>
						<option value="">選択してください</option>
						<option value="SOUMU">SOUMU（総務部門）</option>
						<option value="EIGYO">EIGYO（営業部門）</option>
						<option value="DEV">DEV（開発部門）</option>
					</select>
					<div th:if="${#fields.hasErrors('deptCode') and targetUser == null}" th:errors="*{deptCode}"
						style="color: red; font-size: 0.8rem;"></div>
				</div>

				<div class="form-group">
					<label for="newDeptName">所属名：</label>
					<input type="text" th:field="*{deptName}" id="newDeptName" placeholder="例：開発部門" required>
					<div th:if="${#fields.hasErrors('deptName') and targetUser == null}" th:errors="*{deptName}"
						style="color: red; font-size: 0.8rem;"></div>
				</div>

				<div class="form-group">
					<label for="newName">氏名：</label>
					<input type="text" th:field="*{name}" id="newName" placeholder="例：山田太郎" required>
					<div th:if="${#fields.hasErrors('name') and targetUser == null}" th:errors="*{name}"
						style="color: red; font-size: 0.8rem;"></div>
				</div>

				<div class="button-group">
					<button type="submit" class="btn-primary">登録</button>
				</div>
			</form>
		</div>
	</div>

	<script>
		// 重複送信防止
		function preventDuplicateSubmit(form) {
			const submitBtn = form.querySelector('button[type="submit"]');
			if (submitBtn.disabled) {
				return false;
			}
			submitBtn.disabled = true;
			submitBtn.textContent = '処理中...';
			return true;
		}

		// 削除処理
		function deleteUser() {
			if (confirm('本当に削除しますか？')) {
				const userId = document.getElementById('editUserId').value;
				
				const form = document.createElement('form');
				form.method = 'POST';
				form.action = '/user/delete';
				
				const input = document.createElement('input');
				input.type = 'hidden';
				input.name = 'userId';
				input.value = userId;
				
				form.appendChild(input);
				document.body.appendChild(form);
				form.submit();
			}
		}

		function confirmLogout() {
			if (confirm('ログアウトしますか？')) {
				window.location.href = '/logout';
			}
		}

		// ページ読み込み時にボタンの状態をリセット
		window.addEventListener('load', function() {
			const buttons = document.querySelectorAll('button[type="submit"]');
			buttons.forEach(btn => {
				btn.disabled = false;
				if (btn.textContent === '処理中...') {
					btn.textContent = btn.closest('form').id === 'updateForm' ? '更新' : '登録';
				}
			});
		});
	</script>
</body>

</html>